{% extends 'base.html' %}
{% block title %}Admin - Manage Items{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold text-indigo-600 mb-6 text-center">
        Manage Reported Items
    </h1>

    <!-- Status Filter -->
    <div class="mb-4 flex justify-end">
        <select id="statusFilter"
            class="border-2 border-gray-300 rounded px-4 py-2 focus:border-indigo-600">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="active">Verified</option>
            <option value="matched">Matched</option>
        </select>
    </div>

    <!-- Inline Message -->
    <div id="adminMessage"
         class="hidden mb-4 p-3 rounded text-sm font-semibold text-center">
    </div>

    <!-- Items Table -->
    <div class="overflow-x-auto bg-white rounded shadow">
        <table class="w-full text-left">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-3">Image</th>
                    <th class="p-3">Item</th>
                    <th class="p-3">Category</th>
                    <th class="p-3">Location</th>
                    <th class="p-3">Status</th>
                    <th class="p-3">Actions</th>
                </tr>
            </thead>
            <tbody id="itemsTable">
                {% for item in items %}
                <tr data-status="{{ item.status }}" class="border-t">
                    <td class="p-3">
                        {% if item.image %}
                            <img src="{{ url_for('static', filename='uploads/' + item.image) }}"
                                 class="h-12 w-12 object-cover rounded">
                        {% else %}
                            <span class="text-2xl">ðŸ“¦</span>
                        {% endif %}
                    </td>
                    <td class="p-3 font-semibold">{{ item.name }}</td>
                    <td class="p-3">{{ item.category }}</td>
                    <td class="p-3">{{ item.location }}</td>
                    <td class="p-3 capitalize">{{ item.status }}</td>
                    <td class="p-3 space-x-2">
                        {% if not item.verified %}
                        <button onclick="verifyItem('{{ item.id }}')"
                            class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                            Verify
                        </button>
                        <button onclick="rejectItem('{{ item.id }}')"
                            class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                            Reject
                        </button>
                        {% else %}
                        <span class="text-gray-500 text-sm">No actions</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
/* ---------- STATUS FILTER ---------- */
document.getElementById('statusFilter').addEventListener('change', function () {
    const value = this.value;
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        row.style.display =
            (value === 'all' || row.dataset.status === value) ? '' : 'none';
    });
});

/* ---------- VERIFY ITEM ---------- */
function verifyItem(itemId) {
    fetch(`/api/admin/verify/${itemId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            showMessage(data.message, data.success);
            if (data.success) {
                showMessage(data.message, true);
                location.reload();
            }
        });
}

/* ---------- REJECT ITEM ---------- */
function rejectItem(itemId) {
    fetch(`/api/admin/reject/${itemId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            showMessage(data.message, data.success);
            if (data.success) {
                showMessage(data.message, true);
                location.reload();
            }
        });
}

/* ---------- MESSAGE HANDLER ---------- */
function showMessage(text, success) {
    const msg = document.getElementById('adminMessage');
    msg.className = 'mb-4 p-3 rounded text-sm font-semibold text-center';
    msg.classList.add(success ? 'bg-green-100 text-green-700'
                              : 'bg-red-100 text-red-700');
    msg.textContent = text;
    msg.classList.remove('hidden');
}
</script>
{% endblock %}